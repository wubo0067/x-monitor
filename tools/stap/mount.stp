#!/usr/bin/env stap

global mnt_share_list_add_count, add_backtraces, mnt_share_list_del_count

// list_del_init(&mnt->mnt_share);
probe kernel.statement(0xffffffffab08f498).absolute!,
      kernel.statement(0xFFFFFFFFAB08F4AD).absolute?
{
    mnt_share_list_del_count++
    printf("comm:'%s'", task_execname(task_current()))
    printf("%s\n", sprint_backtrace())
    printf("%s\n\n", sprint_ubacktrace())
    //del_backtraces[execname(), backtrace()]++
}

probe kernel.function("clone_mnt")
{ if(!($flag & 0x10)) { if(($flag & 0x08)|| ($old->mnt->mnt_flags & 0x1000)) { {
    mnt_share_list_add_count++
    printf("comm:'%s', old.mountpoint:'%s', old.dev_name:'%s', root:'%s', flag:(%d)\n",
        task_execname(task_current()),
        task_dentry_path(task_current(), $old->mnt_mountpoint, &($old->mnt)),
        kernel_string($old->mnt_devname),
        d_name($root), $flag)
    printf("%s\n", sprint_backtrace())
    printf("%s\n\n", sprint_ubacktrace())
   //add_backtraces[execname(), backtrace()]++
}} }}


probe timer.s(3)
{
    printf("add_list(%d) del_list:(%d)\n", mnt_share_list_add_count, mnt_share_list_del_count)
}
